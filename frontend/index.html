<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blind Opportunity Detector Dashboard</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f7fa; padding:20px; transition: background 0.3s, color 0.3s; }
body.dark { background:#1f2937; color:#f3f4f6; }

.dashboard { max-width:1400px; margin:0 auto; background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); transition: background 0.3s, color 0.3s; }
body.dark .dashboard { background:#111827; color:#f3f4f6; }

.header { background: linear-gradient(135deg,#2563eb 0%,#1e40af 100%); color:white; padding:30px; border-radius:12px 12px 0 0; display:flex; align-items:center; gap:15px; }
.header-icon { width:60px; height:60px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; color:#2563eb; }
.header-title h1 { font-size:28px; font-weight:600; margin-bottom:5px; }
.header-title p { font-size:14px; opacity:0.9; }

.content { padding:30px; }

/* Metrics */
.metrics-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
.metric-card { background:white; border:1px solid #e5e7eb; border-radius:10px; padding:20px; text-align:center; transition: background 0.3s, color 0.3s; }
body.dark .metric-card { background:#1f2937; color:#f3f4f6; border-color:#374151; }
.metric-label { color:#6b7280; font-size:13px; font-weight:500; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px; }
.metric-value { font-size:28px; font-weight:700; color:#1f2937; margin-bottom:5px; }
body.dark .metric-value { color:#f3f4f6; }

/* Opportunity Input */
.opportunity-form { margin-bottom:30px; display:flex; flex-direction:column; gap:15px; }
.opportunity-form textarea { width:100%; min-height:80px; padding:12px; border-radius:8px; border:1px solid #e5e7eb; font-size:14px; resize:none; }
body.dark .opportunity-form textarea { background:#111827; color:#f3f4f6; border:1px solid #374151; }
.opportunity-form button { width:200px; padding:10px; border:none; border-radius:8px; background:#2563eb; color:white; font-weight:600; cursor:pointer; transition:0.2s; }
.opportunity-form button:hover { background:#1e40af; }

/* Cards */
.cards-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; }
.opportunity-card { background:white; border-radius:12px; padding:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s, background 0.3s, color 0.3s; }
body.dark .opportunity-card { background:#111827; color:#f3f4f6; box-shadow:0 2px 6px rgba(255,255,255,0.05); }
.opportunity-card:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
.opportunity-text { font-weight:500; margin-bottom:10px; color:#1f2937; }
body.dark .opportunity-text { color:#f3f4f6; }
.badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:500; color:white; margin-bottom:6px; }
.Internship { background:#2563eb; }
.Job { background:#16a34a; }
.Scholarship { background:#f59e0b; }
.General { background:#6b7280; }
.alerted-students, .missed-students { font-size:13px; color:#374151; margin-top:8px; }
body.dark .alerted-students, body.dark .missed-students { color:#d1d5db; }
.expand-toggle { cursor:pointer; color:#2563eb; font-weight:500; display:inline-block; margin-left:5px; }
body.dark .expand-toggle { color:#60a5fa; }

/* Charts */
.charts { display:flex; flex-wrap:wrap; gap:20px; margin-bottom:30px; }
.chart { flex:1; min-width:250px; background:white; border-radius:12px; padding:20px; text-align:center; }
body.dark .chart { background:#1f2937; color:#f3f4f6; }
.chart canvas { max-width:100%; }

/* Buttons */
.actions { display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; }
button.action-btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; background:#2563eb; color:white; font-weight:600; transition:0.2s; }
button.action-btn:hover { background:#1e40af; }

/* Toast */
.toast { position:fixed; bottom:20px; right:20px; padding:12px 20px; border-radius:8px; background:#16a34a; color:white; font-weight:500; opacity:0; transform:translateY(20px); transition:0.3s; z-index:999; }

/* Responsive */
@media(max-width:768px){ .metrics-grid{grid-template-columns:1fr;} .cards-container{grid-template-columns:1fr;} .charts{flex-direction:column;} }
</style>
</head>
<body>
<div class="dashboard">
    <div class="header">
        <div class="header-icon">ðŸ“Š</div>
        <div class="header-title">
            <h1>Blind Opportunity Detector</h1>
            <p>Interactive Dashboard</p>
        </div>
    </div>
    <div class="content">
        <!-- Actions -->
        <div class="actions">
            <button class="action-btn" id="dark-toggle">Toggle Dark Mode</button>
            <button class="action-btn" id="export-btn">Export CSV</button>
        </div>

        <!-- Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Opportunities</div>
                <div class="metric-value" id="total-opps">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Alerted Students</div>
                <div class="metric-value" id="total-alerted">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Missed Students</div>
                <div class="metric-value" id="total-missed">0</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts">
            <div class="chart">
                <h4>Matched vs Missed Students</h4>
                <canvas id="donutChart" width="200" height="200"></canvas>
            </div>
            <div class="chart">
                <h4>Students by Category</h4>
                <canvas id="barChart" width="200" height="200"></canvas>
            </div>
        </div>

        <!-- Input -->
        <div class="opportunity-form">
            <textarea id="opportunity-input" placeholder="Paste opportunity details here (one per line)..."></textarea>
            <button id="submit-btn">Submit Opportunity</button>
        </div>

        <!-- Search -->
        <input type="text" id="search-input" placeholder="Search opportunities..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;margin-bottom:15px;">
        
        <!-- Cards -->
        <div class="cards-container" id="cards-container"></div>
    </div>
</div>

<div class="toast" id="toast">Opportunity submitted!</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const cardsContainer = document.getElementById('cards-container');
const totalOppsEl = document.getElementById('total-opps');
const totalAlertedEl = document.getElementById('total-alerted');
const totalMissedEl = document.getElementById('total-missed');
const submitBtn = document.getElementById('submit-btn');
const opportunityInput = document.getElementById('opportunity-input');
const toastEl = document.getElementById('toast');
const searchInput = document.getElementById('search-input');
const darkToggle = document.getElementById('dark-toggle');

let metrics = { total:0, matched:0, missed:0 };
let categoryCounts = { Internship:0, Job:0, Scholarship:0, General:0 };
let allOpportunities = [];

// Charts
const donutCtx = document.getElementById('donutChart').getContext('2d');
const donutChart = new Chart(donutCtx, {
    type: 'doughnut',
    data: {
        labels: ['Matched','Missed'],
        datasets: [{ data: [1,1], backgroundColor: ['#2563eb','#f59e0b'] }]
    },
    options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
});

const barCtx = document.getElementById('barChart').getContext('2d');
const barChart = new Chart(barCtx, {
    type:'bar',
    data:{ labels:['Internship','Job','Scholarship','General'], datasets:[{label:'Students', data:[0,0,0,0], backgroundColor:['#2563eb','#16a34a','#f59e0b','#6b7280']}] },
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
});

// Toast
function showToast(msg){
    toastEl.textContent = msg;
    toastEl.style.opacity = '1';
    toastEl.style.transform = 'translateY(0)';
    setTimeout(()=>{ toastEl.style.opacity='0'; toastEl.style.transform='translateY(20px)'; },2000);
}

// Dark mode persistence
if(localStorage.getItem('dark')==='true') document.body.classList.add('dark');
darkToggle.addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    localStorage.setItem('dark', document.body.classList.contains('dark'));
});

// Update donut chart
function updateDonutChart(){
    donutChart.data.datasets[0].data = (metrics.matched===0 && metrics.missed===0) ? [1,1] : [metrics.matched, metrics.missed];
    donutChart.update();
}

// Submit opportunities
submitBtn.addEventListener('click', async ()=>{
    const text = opportunityInput.value.trim();
    if(!text) return alert('Please enter opportunity text!');

    const opportunities = text.split('\n').map(op=>op.trim()).filter(op=>op.length>0);

    for(const opText of opportunities){
        try{
            const res = await fetch('http://localhost:4000/process-opportunity',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ opportunityText: opText })
            });
            const data = await res.json();

            // Update metrics
            metrics.total++;
            metrics.matched += data.alertedStudents.length;
            metrics.missed += data.missedStudents.length;
            totalOppsEl.textContent = metrics.total;
            totalAlertedEl.textContent = metrics.matched;
            totalMissedEl.textContent = metrics.missed;

            // Update charts
            categoryCounts[data.category] = (categoryCounts[data.category]||0) + data.alertedStudents.length;
            barChart.data.datasets[0].data = Object.values(categoryCounts);
            barChart.update();
            updateDonutChart();

            // Create card
            const card = document.createElement('div');
            card.className='opportunity-card';
            card.dataset.category=data.category;
            card.dataset.text=data.opportunity.toLowerCase();

            card.innerHTML = `
                <div class="opportunity-text">${data.opportunity}</div>
                <div class="badge ${data.category}">${data.category}</div>
                <div class="alerted-students">
                    Alerted Students: <span class="students-count">${data.alertedStudents.length}</span>
                    ${data.alertedStudents.length>0?'<span class="expand-toggle">[+]</span>':''}
                    <div class="students-list" style="display:none; margin-top:5px;">
                        ${data.alertedStudents.map(s=>s.name).join(', ')}
                    </div>
                </div>
                <div class="missed-students">
                    Missed Students: <span class="students-count">${data.missedStudents.length}</span>
                    ${data.missedStudents.length>0?'<span class="expand-toggle-missed">[+]</span>':''}
                    <div class="students-list-missed" style="display:none; margin-top:5px;">
                        ${data.missedStudents.map(s=>s.name).join(', ')}
                    </div>
                </div>
            `;
            cardsContainer.prepend(card);
            allOpportunities.unshift(card);

            // Toggle for alerted
            const toggle = card.querySelector('.expand-toggle');
            if(toggle){
                toggle.addEventListener('click', ()=>{
                    const list = card.querySelector('.students-list');
                    list.style.display = list.style.display==='none'?'block':'none';
                    toggle.textContent = list.style.display==='none'? '[+]':'[-]';
                });
            }

            // Toggle for missed
            const toggleMissed = card.querySelector('.expand-toggle-missed');
            if(toggleMissed){
                toggleMissed.addEventListener('click', ()=>{
                    const list = card.querySelector('.students-list-missed');
                    list.style.display = list.style.display==='none'?'block':'none';
                    toggleMissed.textContent = list.style.display==='none'? '[+]':'[-]';
                });
            }

        }catch(err){ console.error(err); alert('Error submitting opportunity. Make sure backend is running!'); }
    }

    opportunityInput.value='';
    showToast('Opportunity(s) submitted!');
});

// Search/filter
searchInput.addEventListener('input', ()=>{
    const term = searchInput.value.toLowerCase();
    allOpportunities.forEach(card=>{
        card.style.display = card.dataset.text.includes(term) ? '' : 'none';
    });
});

// Export CSV
document.getElementById('export-btn').addEventListener('click', ()=>{
    let csv='Opportunity,Category,Alerted Students,Missed Students\n';
    allOpportunities.forEach(card=>{
        const opp = card.querySelector('.opportunity-text').textContent;
        const cat = card.querySelector('.badge').textContent;
        const alerted = card.querySelector('.students-list').textContent || 'None';
        const missed = card.querySelector('.students-list-missed').textContent || 'None';
        csv += `"${opp.replace(/"/g,'""')}","${cat}","${alerted.replace(/"/g,'""')}","${missed.replace(/"/g,'""')}"\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='opportunities.csv'; a.click();
    URL.revokeObjectURL(url);
});
</script>
</body>
</html>